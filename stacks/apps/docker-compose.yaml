x-base: &base
  mem_limit: ${MEM_LIMIT}
  restart: ${RESTART}
x-env: &env
  TZ: ${TZ}
x-uid: &uid
  PUID: ${PUID}
  PGID: ${PGID}
  UMASK: ${UMASK}
x-envuid: &envuid
  <<:
  - *env
  - *uid
x-baseenv: &baseenv
  <<: *base
  environment:
    <<: *env
x-baseuid: &baseuid
  <<: *base
  environment:
    <<: *envuid
services:
  homeassistant:
    <<: *baseuid
    container_name: homeassistant
    image: ${HA_IMAGE}:${HA_TAG}
    network_mode: bridge
    ports:
    - 8123:8123
    labels:
      homelab.backup.paths: "/opt/home_assistant"
      homelab.backup.exclude: ".cache,deps,__pycache__,*.pyc"
      homelab.health_timeout: "150"
    volumes:
    - ${APPSDIR}/home_assistant/:/config
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8123/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
  guacamole:
    <<: *base
    container_name: guacamole
    image: ${GUAC_IMAGE}:${GUAC_TAG}
    network_mode: bridge
    ports:
    - 8084:8080
    labels:
      homelab.backup.paths: "/opt/guacamole"
    environment:
      <<: *env
      EXTENSIONS: ${GUAC_EXTENSIONS}
    volumes:
    - ${APPSDIR}/guacamole:/config
    - ${APPSDIR}/guacamole/server.xml:/usr/local/tomcat/conf/server.xml
    privileged: true
  firefox:
    <<: *base
    container_name: firefox
    image: ${FIREFOX_IMAGE}:${FIREFOX_TAG}
    network_mode: bridge
    ports:
    - 7814:5800
    - 7914:5900
    labels:
      homelab.backup.paths: "/opt/firefox"
    environment:
      <<: *envuid
      DISPLAY_WIDTH: ${FF_DISPLAY_WIDTH}
      DISPLAY_HEIGHT: ${FF_DISPLAY_HEIGHT}
      SECURE_CONNECTION: ${FF_SECURE_CONNECTION}
      DARK_MODE: ${FF_DARK_MODE}
      WEB_AUDIO: ${FF_WEB_AUDIO}
    volumes:
    - ${APPSDIR}/firefox:/config
    shm_size: 2g
  xbackbone:
    <<: *baseuid
    container_name: xbackbone
    image: ${XBACKBONE_IMAGE}:${XBACKBONE_TAG}
    network_mode: bridge
    ports:
    - 8088:80
    - 8444:443
    labels:
      homelab.backup.paths: "/opt/xbackbone"
    volumes:
    - ${APPSDIR}/xbackbone:/config
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  homepage:
    <<: *base
    container_name: homepage
    image: ${HOMEPAGE_IMAGE}:${HOMEPAGE_TAG}
    network_mode: bridge
    ports:
      - 3003:3000
    labels:
      homelab.backup.paths: "/opt/homepage"
    environment:
      <<: *envuid
      HOMEPAGE_ALLOWED_HOSTS: ${HOMEPAGE_ALLOWED_HOSTS}
    volumes:
      - ${APPSDIR}/homepage:/app/config
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  homebox:
    <<: *baseenv
    container_name: homebox
    image: ${HOMEBOX_IMAGE}:${HOMEBOX_TAG}
    network_mode: bridge
    ports:
      - 3100:7745
    labels:
      homelab.backup.paths: "/opt/homebox"
    volumes:
      - ${APPSDIR}/homebox:/data/
  rickroll:
    <<: *baseenv
    container_name: rickroll
    image: ${RICKROLL_IMAGE}:${RICKROLL_TAG}
    network_mode: bridge
    ports:
    - 7344:8080
  cloudflareddns:
    <<: *base
    container_name: cloudflareddns
    image: ${DDNS_IMAGE}:${DDNS_TAG}
    network_mode: bridge
    labels:
      homelab.backup.paths: "/opt/cloudflareddns"
    environment:
      <<: *envuid
      INTERVAL: ${DDNS_INTERVAL}
      DETECTION_MODE: ${DDNS_DETECTION_MODE}
      LOG_LEVEL: ${DDNS_LOG_LEVEL}
      CF_USER: ${EMAIL}
      CF_APIKEY: ${DDNS_CF_APIKEY}
      CF_HOSTS: ${DDNS_CF_HOSTS}
      CF_ZONES: ${DDNS_CF_ZONES}
      CF_RECORDTYPES: ${DDNS_CF_RECORDTYPES}
    volumes:
    - ${APPSDIR}/cloudflareddns:/config
