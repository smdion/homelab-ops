x-base: &base
  mem_limit: ${MEM_LIMIT}
  restart: ${RESTART}
x-env: &env
  TZ: ${TZ}
x-uid: &uid
  PUID: ${PUID}
  PGID: ${PGID}
  UMASK: ${UMASK}
x-envuid: &envuid
  <<:
  - *env
  - *uid
services:
  code-server:
    <<: *base
    container_name: code-server
    image: lscr.io/linuxserver/code-server
    network_mode: bridge
    ports:
    - 8443:8443
    labels:
      homelab.backup.paths: "/opt/code-server"
      homelab.health_timeout: "90"
    environment:
      <<: *envuid
      PROXY_DOMAIN: ${CODESERVER_PROXY_DOMAIN}
      DEFAULT_WORKSPACE: ${CODESERVER_DEFAULT_WORKSPACE}
    volumes:
    - core:/workspace/core
    - apps:/workspace/apps
    - dev:/workspace/dev
    - vps:/workspace/vps
    - ${APPSDIR}/code-server:/config
    - ./custom-cont-init.d:/custom-cont-init.d:ro
    healthcheck:
      test: ["CMD-SHELL", "ls /workspace/core /workspace/apps /workspace/dev /workspace/vps > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  netbootxyz:
    <<: *base
    container_name: netbootxyz
    image: netbootxyz/netbootxyz:latest
    network_mode: bridge
    labels:
      homelab.backup.paths: "/opt/netboot"
    ports:
      - 3002:3000
      - 69:69/udp
      - 8082:80
    environment:
      <<: *envuid
    volumes:
      - ${APPSDIR}/netboot/config:/config
      - ${APPSDIR}/netboot/assets:/assets
volumes:
  # NFS mounts (core, apps from other VMs), local bind (dev), and VPS NFS are
  # deployment-specific â€” defined in docker-compose.override.j2, which deploy_stacks.yaml
  # templates to docker-compose.override.yaml on the host. See DESIGN.md for details.
  core:
  apps:
  dev:
  vps:
