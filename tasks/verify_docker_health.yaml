---
# Poll Docker containers until all are healthy (or no health checks defined).
# Warns (does not fail) if any container remains unhealthy/starting after timeout.
#
# Optional:
#   _health_timeout  — seconds to poll (overrides label discovery; default: auto-discover from labels, min docker_health_poll_timeout)
#   _health_delay    — seconds between polls (default 10)
#   _test_mode       — when true, containers with homelab.test.skip_health=true are excluded
# Sets:
#   _health_summary  — human-readable container status summary for logging
#   _health_warning  — true if containers were still unhealthy/starting after timeout

- name: Wait for containers to become healthy
  become: true
  ansible.builtin.shell:
    cmd: |
      # Discover max timeout from homelab.health_timeout labels if not explicitly passed
      timeout={{ _health_timeout | default(0) }}
      if [ "$timeout" -eq 0 ]; then
        timeout={{ docker_health_poll_timeout }}
        for t in $(docker ps -q | xargs -r docker inspect --format '{% raw %}{{index .Config.Labels "homelab.health_timeout"}}{% endraw %}' 2>/dev/null | grep -E '^[0-9]+$'); do
          [ "$t" -gt "$timeout" ] && timeout=$t
        done
      fi

      delay={{ _health_delay | default(10) }}
      elapsed=0

      # Build skip list from homelab.test.skip_health label (only in test mode)
      skip_pattern=""
      if [ "{{ _test_mode | default(false) | bool | lower }}" = "true" ]; then
        skip_names=$(docker ps -a \
          --filter "label=homelab.test.skip_health=true" \
          --format '{% raw %}{{.Names}}{% endraw %}' 2>/dev/null)
        [ -n "$skip_names" ] && \
          skip_pattern=$(echo "$skip_names" | tr '\n' '|' | sed 's/|$//')
      fi

      while [ $elapsed -lt $timeout ]; do
        unhealthy=$(docker ps --filter health=unhealthy --format '{% raw %}{{.Names}}{% endraw %}' 2>/dev/null)
        starting=$(docker ps --filter health=starting --format '{% raw %}{{.Names}}{% endraw %}' 2>/dev/null)
        if [ -n "$skip_pattern" ]; then
          unhealthy=$(echo "$unhealthy" | grep -vE "^($skip_pattern)$" || true)
          starting=$(echo "$starting"   | grep -vE "^($skip_pattern)$" || true)
        fi
        if [ -z "$unhealthy" ] && [ -z "$starting" ]; then
          echo "ALL_HEALTHY"
          exit 0
        fi
        sleep $delay
        elapsed=$((elapsed + delay))
      done
      # Timed out — report what's still unhealthy
      echo "UNHEALTHY: $unhealthy"
      echo "STARTING: $starting"
      exit 1
  register: _health_poll
  changed_when: false
  failed_when: false
  when: not ansible_check_mode

- name: Set health warning flag
  ansible.builtin.set_fact:
    _health_warning: "{{ _health_poll.rc | default(0) | int != 0 }}"
  when: not ansible_check_mode

- name: Warn about containers not yet healthy
  ansible.builtin.debug:
    msg: >-
      WARNING — Some containers are still unhealthy or starting after timeout.
      {{ _health_poll.stdout_lines | default([]) | join('; ') }}
      This may resolve once dependencies finish starting.
  when:
    - not ansible_check_mode
    - _health_warning | default(false) | bool

- name: Build health summary
  ansible.builtin.shell: |
    docker ps --format '{% raw %}{{.Names}}: {{.Status}}{% endraw %}' | sort
  become: true
  register: _health_status
  changed_when: false
  when: not ansible_check_mode

- name: Set health summary fact
  ansible.builtin.set_fact:
    _health_summary: "{{ _health_status.stdout | default('check mode — skipped') }}"
  when: not ansible_check_mode

- name: Set health summary fact (check mode)
  ansible.builtin.set_fact:
    _health_summary: "check mode — skipped"
  when: ansible_check_mode
