---
# Poll Docker containers until all are healthy (or no health checks defined).
# Fails if any container remains unhealthy after timeout.
#
# Optional:
#   _health_timeout  — seconds to poll (default 120)
#   _health_delay    — seconds between polls (default 10)
# Sets:
#   _health_summary  — human-readable container status summary for logging

- name: Wait for containers to become healthy
  become: true
  ansible.builtin.shell:
    cmd: |
      timeout={{ _health_timeout | default(120) }}
      delay={{ _health_delay | default(10) }}
      elapsed=0
    while [ $elapsed -lt $timeout ]; do
      unhealthy=$(docker ps --filter health=unhealthy --format '{% raw %}{{.Names}}{% endraw %}' 2>/dev/null)
      starting=$(docker ps --filter health=starting --format '{% raw %}{{.Names}}{% endraw %}' 2>/dev/null)
      if [ -z "$unhealthy" ] && [ -z "$starting" ]; then
        echo "ALL_HEALTHY"
        exit 0
      fi
      sleep $delay
      elapsed=$((elapsed + delay))
    done
    # Timed out — report what's still unhealthy
    echo "UNHEALTHY: $unhealthy"
    echo "STARTING: $starting"
    exit 1
  register: _health_poll
  changed_when: false
  when: not ansible_check_mode

- name: Build health summary
  ansible.builtin.shell: |
    docker ps --format '{% raw %}{{.Names}}: {{.Status}}{% endraw %}' | sort
  become: true
  register: _health_status
  changed_when: false
  when: not ansible_check_mode

- name: Set health summary fact
  ansible.builtin.set_fact:
    _health_summary: "{{ _health_status.stdout | default('check mode — skipped') }}"
  when: not ansible_check_mode

- name: Set health summary fact (check mode)
  ansible.builtin.set_fact:
    _health_summary: "check mode — skipped"
  when: ansible_check_mode
