---
# Parameterized notification task — sends to Discord and/or Apprise.
# Pass all variables via vars: on the include_tasks call.
#
# Standard operational vars (preferred for all playbooks):
#   discord_name         — system name (Database, Docker, unRAID, etc.)
#   discord_operation    — operation name (Backup, Verification, Restore, Deploy, etc.)
#                          Combined with discord_name to auto-build title: "{name} {operation}"
#   discord_status       — "successful", "failed", or "partial"
#                          Auto-builds description; combine with discord_detail for "Status — detail"
#   discord_detail       — optional detail appended to description: "Successful — radarr-log"
#   discord_color        — embed color (use discord_color_success/failure/warning/rollback from group_vars/all.yaml)
#   discord_fields       — list of {name: ..., value: ..., inline: bool} dicts; inline: true renders
#                          3 fields per row (omit or [] for minimal alerts)
#
# Legacy/override vars (for special callers: maintain_health hardcoded alerts, download_videos):
#   discord_title        — explicit embed title (used when discord_name/discord_operation not set)
#   discord_description  — explicit embed body text (used when discord_status not set)
#
# Optional vars — embed content:
#   discord_url          — clickable link on title (backup/update/maintenance playbooks)
#   discord_footer       — dict with 'text' and optional 'icon_url' keys (download_videos per-video)
#   discord_timestamp    — ISO timestamp (defaults to ansible_date_time.iso8601)
#
# Optional vars — author overrides:
#   discord_author       — override author name (defaults to inventory_hostname;
#                          maintain_health passes controller_fqdn for localhost plays)
#   discord_author_icon  — override author icon URL (defaults to Semaphore PNG;
#                          download_videos per-video uses platform icon)
#   discord_author_url   — clickable link on author name (download_videos per-video
#                          links to channel URL)
#
# Optional vars — webhook/bot overrides:
#   discord_username     — override webhook bot name (defaults to "Ansible Bot";
#                          download_videos per-video uses "{uploader} - MeTube Bot")
#   discord_avatar       — override webhook bot avatar (defaults to Semaphore PNG;
#                          download_videos per-video uses MeTube icon)
#
# Optional vars — media overrides:
#   discord_thumbnail    — override small thumbnail (defaults to unRAID notify PNG)
#   discord_image        — large embed image (download_videos per-video uses video thumbnail)
#
# Inherited from playbook scope (no need to pass):
#   discord_webhook_id, discord_webhook_token — from vars/secrets.yaml; callers that need
#     a different webhook (e.g., download_videos MeTube channel) override these via vars:
#   inventory_hostname, ansible_date_time
#
# Optional Apprise vars (from vars/secrets.yaml; both silent if unset):
#   apprise_urls     — space-separated Apprise URL(s) for CLI mode (pip install apprise required)
#   apprise_api_url  — Apprise API base URL for API mode (e.g., http://apprise-api:8000)
#   apprise_api_key  — Apprise API key (default: "ansible")

- name: Send Discord notification
  community.general.discord:
    username: "{{ discord_username | default('Ansible Bot') }}"
    avatar_url: "{{ discord_avatar | default('https://raw.githubusercontent.com/imagegenius/templates/main/unraid/img/semaphore.png') }}"
    webhook_id: "{{ discord_webhook_id }}"
    webhook_token: "{{ discord_webhook_token }}"
    embeds:
      - >-
        {{
          {
            'title': (discord_name ~ ' ' ~ discord_operation) if (discord_name is defined and discord_operation is defined) else discord_title,
            'color': discord_color,
            'fields': discord_fields | default([]),
            'timestamp': discord_timestamp | default(ansible_date_time.iso8601),
            'author':
              {'name': discord_author | default(inventory_hostname),
               'icon_url': discord_author_icon | default('https://raw.githubusercontent.com/imagegenius/templates/main/unraid/img/semaphore.png')}
              | combine({'url': discord_author_url} if discord_author_url | default('') | length > 0 else {}),
            'thumbnail': {
              'url': discord_thumbnail | default('https://craftassets.unraid.net/uploads/discord/notify-normal.png')
            }
          }
          | combine(
              {'description': (discord_status | capitalize) ~ ((' — ' ~ discord_detail) if discord_detail | default('') | length > 0 else '')}
              if discord_status is defined
              else ({'description': discord_description} if discord_description | default('') | length > 0 else {})
            )
          | combine({'url': discord_url} if discord_url | default('') | length > 0 else {})
          | combine({'footer': discord_footer} if discord_footer is defined else {})
          | combine({'image': {'url': discord_image}} if discord_image | default('') | length > 0 else {})
        }}
  register: _discord_result
  retries: 3
  delay: 5
  until: _discord_result is succeeded
  failed_when: false
  when:
    - not ansible_check_mode
    - discord_webhook_id is defined
    - discord_webhook_token is defined
  no_log: "{{ not (debug_no_log | default(false) | bool) and (ansible_verbosity | default(0) | int < 3) }}"
  tags: [always]

# --- Apprise notifications (optional) ---
# Both tasks are silent if their respective vars are not set in secrets.yaml.

- name: Send Apprise notification (CLI)
  vars:
    _apprise_title: >-
      {{ (discord_name ~ ' ' ~ discord_operation)
         if (discord_name is defined and discord_operation is defined)
         else (discord_title | default('Ansible Alert')) }}
    _apprise_body: >-
      {{ ((discord_status | capitalize) ~
          ((' — ' ~ discord_detail) if discord_detail | default('') | length > 0 else ''))
         if discord_status is defined
         else (discord_description | default('')) }}
  ansible.builtin.command:
    argv:
      - apprise
      - --title
      - "{{ _apprise_title }}"
      - --body
      - "{{ _apprise_body }}"
      - "{{ apprise_urls }}"
  delegate_to: localhost
  failed_when: false
  when:
    - not ansible_check_mode
    - apprise_urls is defined
    - apprise_urls | length > 0
  no_log: "{{ not (debug_no_log | default(false) | bool) and (ansible_verbosity | default(0) | int < 3) }}"
  tags: [always]

- name: Send Apprise notification (API)
  vars:
    _apprise_title: >-
      {{ (discord_name ~ ' ' ~ discord_operation)
         if (discord_name is defined and discord_operation is defined)
         else (discord_title | default('Ansible Alert')) }}
    _apprise_body: >-
      {{ ((discord_status | capitalize) ~
          ((' — ' ~ discord_detail) if discord_detail | default('') | length > 0 else ''))
         if discord_status is defined
         else (discord_description | default('')) }}
    _apprise_type: >-
      {{ 'success' if discord_status | default('') == 'successful'
         else ('failure' if discord_status | default('') == 'failed'
         else ('warning' if discord_status | default('') == 'partial'
         else 'info')) }}
  ansible.builtin.uri:
    url: "{{ apprise_api_url }}/notify/{{ apprise_api_key | default('ansible') }}"
    method: POST
    body_format: json
    body:
      title: "{{ _apprise_title }}"
      body: "{{ _apprise_body }}"
      type: "{{ _apprise_type }}"
    status_code: [200]
  delegate_to: localhost
  failed_when: false
  when:
    - not ansible_check_mode
    - apprise_api_url is defined
    - apprise_api_url | length > 0
  no_log: "{{ not (debug_no_log | default(false) | bool) and (ansible_verbosity | default(0) | int < 3) }}"
  tags: [always]
