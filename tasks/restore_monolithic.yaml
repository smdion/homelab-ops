---
# Restore full host from a monolithic backup archive.
# Extracted from restore_hosts.yaml.
#
# Expects (from caller scope):
#   backup_base_dir        — controller-side backup root
#   backup_tmp_dir         — temp directory on target host
# Optional:
#   restore_date           — date filter for archive selection
# Sets:
#   restore_failed, _restore_source_file, _restore_detail

- block:
    - name: Find backup archive on controller
      ansible.builtin.shell: >
        ls -t {{ backup_base_dir }}/{{ inventory_hostname }}/backup_*{{ restore_date | default('') }}*.tar.gz
        2>/dev/null | head -1
      register: _archive_file
      delegate_to: localhost
      become: false
      changed_when: false
      check_mode: false

    - name: Assert backup archive exists
      ansible.builtin.assert:
        that: _archive_file.stdout | length > 0
        fail_msg: "No backup archive found for {{ inventory_hostname }}"

    - name: Set source file fact
      ansible.builtin.set_fact:
        _restore_source_file: "{{ _archive_file.stdout | basename }}"

    - name: Verify archive integrity
      ansible.builtin.shell: |
        {{ _gz_detect }}
        $_gz -t "{{ _archive_file.stdout }}"
      delegate_to: localhost
      become: false
      changed_when: false
      check_mode: false

    # ===== STOP DOCKER =====
    - include_tasks: tasks/docker_stop.yaml
      when: not ansible_check_mode

    # ===== RESTORE APPDATA =====
    - include_tasks: tasks/restore_appdata.yaml
      vars:
        _restore_archive_path: "{{ _archive_file.stdout }}"

    # ===== START DOCKER =====
    - include_tasks: tasks/docker_start.yaml
      when: not ansible_check_mode

    # ===== CLEANUP =====
    - name: Clean up temp archive
      ansible.builtin.file:
        path: "{{ backup_tmp_dir }}/restore.tar.gz"
        state: absent
      become: true

  rescue:
    - name: Set restore failed flag
      ansible.builtin.set_fact:
        restore_failed: true

    - include_tasks: tasks/docker_start.yaml
      vars:
        _docker_ignore_errors: true
