---
# Back up all databases from a single DB config file.
# Called in a loop from backup_hosts.yaml (combined mode via with_databases=yes).
#
# Expects:
#   _db_config_file — config file base name (e.g., "db_primary_mariadb")
#   _db_combined_results — accumulator list (seeded from caller)
#   backup_base_dir — controller backup base path
# Inherits from playbook scope:
#   db_password, ansible_date_time
#
# Vars are loaded directly (no name: prefix) because namespaced dicts
# eagerly template all values — backup_file uses {{ item }} which is
# undefined outside the standalone backup_databases.yaml loop.

- name: "Load DB config — {{ _db_config_file }}"
  ansible.builtin.include_vars:
    file: "vars/{{ _db_config_file }}.yaml"

- name: "Create temp directory on {{ db_host }} — {{ _db_config_file }}"
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ backup_base_dir }}/run_{{ ansible_date_time.iso8601_basic_short }}"
  delegate_to: "{{ db_host }}"

- name: "Seed accumulator — {{ _db_config_file }}"
  ansible.builtin.set_fact:
    combined_results: "{{ _db_combined_results }}"

- name: "Back up databases — {{ _db_config_file }}"
  include_tasks: tasks/backup_single_db.yaml
  loop: "{{ db_names }}"
  loop_control:
    loop_var: _current_db
  vars:
    backup_tmp_dir: "{{ backup_base_dir }}/run_{{ ansible_date_time.iso8601_basic_short }}"
    _db_delegate_host: "{{ db_host }}"

- name: "Sync results — {{ _db_config_file }}"
  ansible.builtin.set_fact:
    _db_combined_results: "{{ combined_results }}"

- name: "Clean up temp directory on {{ db_host }} — {{ _db_config_file }}"
  become: true
  ansible.builtin.file:
    state: absent
    path: "{{ backup_base_dir }}/run_{{ ansible_date_time.iso8601_basic_short }}"
  delegate_to: "{{ db_host }}"
