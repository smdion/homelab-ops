---
# Back up all databases from a single DB config file.
# Called in a loop from backup_hosts.yaml (combined mode via with_databases=yes).
#
# Expects:
#   _db_config_file — config file base name (e.g., "db_primary_mariadb")
#   _db_combined_results — accumulator list (seeded from caller)
#   backup_base_dir — controller backup base path
# Inherits from playbook scope:
#   db_password, ansible_date_time

- name: "Load DB config — {{ _db_config_file }}"
  ansible.builtin.include_vars:
    file: "vars/{{ _db_config_file }}.yaml"
    name: _dbg_vars

- name: "Create temp directory on {{ _dbg_vars.db_host }} — {{ _db_config_file }}"
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ backup_base_dir }}/run_{{ ansible_date_time.iso8601_basic_short }}"
  delegate_to: "{{ _dbg_vars.db_host }}"

- name: "Back up databases — {{ _db_config_file }}"
  include_tasks: tasks/backup_single_db.yaml
  loop: "{{ _dbg_vars.db_names }}"
  loop_control:
    loop_var: _current_db
  vars:
    db_container_name: "{{ _dbg_vars.db_container_name }}"
    db_username: "{{ _dbg_vars.db_username }}"
    db_password: "{{ db_password }}"
    backup_ext: "{{ _dbg_vars.backup_ext | default('sql') }}"
    backup_tmp_dir: "{{ backup_base_dir }}/run_{{ ansible_date_time.iso8601_basic_short }}"
    backup_stack: "{{ _dbg_vars.backup_stack | default(omit) }}"
    is_mariadb: "{{ _dbg_vars.is_mariadb | default(false) }}"
    is_postgres: "{{ _dbg_vars.is_postgres | default(false) }}"
    is_influxdb: "{{ _dbg_vars.is_influxdb | default(false) }}"
    combined_results: "{{ _db_combined_results }}"
    _db_delegate_host: "{{ _dbg_vars.db_host }}"

- name: "Sync results — {{ _db_config_file }}"
  ansible.builtin.set_fact:
    _db_combined_results: "{{ combined_results }}"

- name: "Clean up temp directory on {{ _dbg_vars.db_host }} — {{ _db_config_file }}"
  become: true
  ansible.builtin.file:
    state: absent
    path: "{{ backup_base_dir }}/run_{{ ansible_date_time.iso8601_basic_short }}"
  delegate_to: "{{ _dbg_vars.db_host }}"
