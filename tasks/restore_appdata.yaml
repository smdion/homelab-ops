---
# Restore appdata from backup archive with optional selective app extraction.
#
# Expects:
#   _restore_archive_path  — path to archive on controller
#   backup_tmp_dir         — temp directory on target host
# Optional:
#   _restore_extract_path  — relative path within archive (selective extract)
#   _restore_app_name      — app name (for detail fact)
# Sets:
#   _restore_detail fact for caller's logging

- name: Copy restore archive to target host
  block:
    - name: Copy restore archive via rsync
      ansible.builtin.synchronize:
        src: "{{ _restore_archive_path }}"
        dest: "{{ backup_tmp_dir }}/restore.tar.gz"
        compress: false
        rsync_opts:
          - "--timeout=300"
          - "--whole-file"
  rescue:
    - name: "Rsync stalled — falling back to Ansible copy"
      ansible.builtin.copy:
        src: "{{ _restore_archive_path }}"
        dest: "{{ backup_tmp_dir }}/restore.tar.gz"
        mode: "0644"
  when: not ansible_check_mode

- name: Detect archive root (opt/ prefix or legacy flat layout)
  ansible.builtin.shell: |
    {{ _gz_detect }}
    first=$(tar -I "$_gz" -tf {{ backup_tmp_dir }}/restore.tar.gz | head -1)
    case "$first" in opt/*) echo "/" ;; *) echo "/opt" ;; esac
  become: true
  register: _archive_extract_root
  changed_when: false
  when: not ansible_check_mode

- name: Extract {{ _restore_extract_path | default('') }} from archive (selective)
  ansible.builtin.shell: |
    {{ _gz_detect }}
    tar -I "$_gz" -xf {{ backup_tmp_dir }}/restore.tar.gz -C {{ _archive_extract_root.stdout }} "{{ _restore_extract_path }}"
  become: true
  when:
    - _restore_extract_path | default('') | length > 0
    - not ansible_check_mode

- name: Extract full appdata archive
  ansible.builtin.shell: |
    {{ _gz_detect }}
    tar -I "$_gz" -xf {{ backup_tmp_dir }}/restore.tar.gz -C {{ _archive_extract_root.stdout }}
  become: true
  when:
    - _restore_extract_path | default('') | length == 0
    - not ansible_check_mode

- name: Record appdata restore completion detail
  ansible.builtin.set_fact:
    _restore_detail: "{{ _restore_app_name | default('full') }} restored"
  when: not ansible_check_mode
