---
# Health check logging task — inserts one row into health_checks table.
# NOTE: Currently unused. maintain_health.yaml uses inline batch inserts instead.
# Kept for future single-check logging needs.
# Pass all variables via vars: on the include_tasks call.
#
# Required vars:
#   log_hostname  — FQDN (pass inventory_hostname — already a proper FQDN)
#   hc_check_name — check identifier (26 checks):
#                   Play 1 (DB/API): 'semaphore_tasks', 'stale_backup',
#                     'backup_size_anomaly', 'failed_maintenance',
#                     'stale_maintenance', 'mariadb_health',
#                     'wan_connectivity', 'appliance_reachable'
#                   Play 2 (SSH hosts): 'disk_space', 'memory', 'cpu_load',
#                     'journal_errors', 'oom_kills', 'docker_health',
#                     'smart_health', 'pve_cluster', 'ceph_health', 'ssl_cert',
#                     'ntp_sync', 'dns_resolution', 'unraid_array',
#                     'pbs_datastore', 'zfs_pool', 'btrfs_health', 'docker_http'
#                   Play 3: 'host_reachable'
#   hc_status     — 'ok', 'warning', or 'critical'
#   hc_value      — short metric string (e.g. '89%', 'load: 3.2 / 4 vcpus')
#   hc_detail     — longer free-text detail (e.g. '/var at 89% | /home at 72%')
#
# Inherited from playbook scope (no need to pass):
#   logging_db_host, logging_db_port, logging_db_user,
#   logging_db_password, logging_db_name

- name: Log health check to MariaDB
  vars:
    ansible_python_interpreter: "{{ ansible_playbook_python }}"
  become: false
  connection: local
  community.mysql.mysql_query:
    login_host: "{{ logging_db_host }}"
    login_port: "{{ logging_db_port }}"
    login_user: "{{ logging_db_user }}"
    login_password: "{{ logging_db_password }}"
    login_db: "{{ logging_db_name }}"
    query: >-
      INSERT INTO health_checks (hostname, check_name, check_status, check_value, check_detail, timestamp)
      VALUES (%s, %s, %s, %s, %s, UTC_TIMESTAMP())
    positional_args:
      - "{{ log_hostname }}"
      - "{{ hc_check_name }}"
      - "{{ hc_status }}"
      - "{{ hc_value }}"
      - "{{ hc_detail }}"
  when: not ansible_check_mode
  no_log: "{{ not (debug_no_log | default(false) | bool) and (ansible_verbosity | default(0) | int < 3) }}"
  tags: [always]
