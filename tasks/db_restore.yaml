---
# Restore a single database from backup.
# When _db_target_name differs from _db_name, creates the target DB first (verify flow).
# When _db_target_name equals _db_name, InfluxDB drops the DB first (overwrite flow).
#
# Expects:
#   _db_name, _db_container, _db_username, _db_password (default ''),
#   _db_source_file, _db_is_postgres, _db_is_mariadb, _db_is_influxdb,
#   _db_tmp_dir (InfluxDB only)
# Optional:
#   _db_target_name — target DB name (default: _db_name)
# Registers: _db_restore_result

- block:
    - name: "Restore database — {{ _db_target_name | default(_db_name) }}"
      ansible.builtin.shell: |
        _gz=$(command -v pigz >/dev/null 2>&1 && echo pigz || echo gzip)
        # Auto-detect: use cat for plain .sql, gzip -dc for .sql.gz
        case "{{ _db_source_file }}" in
          *.gz) _decompress="$_gz -dc" ;;
          *)    _decompress="cat" ;;
        esac
        {% set target = _db_target_name | default(_db_name) %}
        {% if _db_is_postgres | default(false) | bool %}
        docker exec {{ _db_container }} psql -U {{ _db_username }} -tc "SELECT 1 FROM pg_database WHERE datname='{{ target }}'" postgres | grep -q 1 \
          || docker exec {{ _db_container }} psql -U {{ _db_username }} -c 'CREATE DATABASE "{{ target }}";' postgres
        $_decompress {{ _db_source_file }} | docker exec -i {{ _db_container }} psql -U {{ _db_username }} "{{ target }}"
        {% elif _db_is_mariadb | default(false) | bool %}
        docker exec -e MYSQL_PWD="$DB_PASSWORD" {{ _db_container }} mysql -u {{ _db_username }} -e "CREATE DATABASE IF NOT EXISTS \`{{ target }}\`;"
        $_decompress {{ _db_source_file }} | docker exec -i -e MYSQL_PWD="$DB_PASSWORD" {{ _db_container }} mysql -u {{ _db_username }} {{ target }}
        {% elif _db_is_influxdb | default(false) | bool %}
        {% if target == _db_name %}
        docker exec {{ _db_container }} influx -execute "DROP DATABASE \"{{ _db_name }}\""
        {% endif %}
        tar -I "$_gz" --no-same-owner --no-same-permissions -xf {{ _db_source_file }} -C {{ _db_tmp_dir }}
        docker cp {{ _db_tmp_dir }}/backup_{{ _db_name }} {{ _db_container }}:/tmp/db_restore_{{ _db_name }}
        {% if target != _db_name %}
        docker exec {{ _db_container }} influxd restore -portable -database {{ _db_name }} -newdb {{ target }} /tmp/db_restore_{{ _db_name }}
        {% else %}
        docker exec {{ _db_container }} influxd restore -portable -database {{ _db_name }} /tmp/db_restore_{{ _db_name }}
        {% endif %}
        rm -rf {{ _db_tmp_dir }}/backup_{{ _db_name }}
        docker exec {{ _db_container }} rm -rf /tmp/db_restore_{{ _db_name }}
        {% endif %}
      environment:
        DB_PASSWORD: "{{ _db_password | default('') }}"
      register: _db_restore_result
      become: true
      no_log: "{{ not (_db_is_influxdb | default(false) | bool) and not (debug_no_log | default(false) | bool) and (ansible_verbosity | default(0) | int < 3) }}"
  rescue:
    - ansible.builtin.fail:
        msg: "Restore database '{{ _db_target_name | default(_db_name) }}' failed. Re-run with -e debug_no_log=yes for details."
