---
# Per-stack deploy loop body — called by deploy_stacks.yaml.
# Expects _current_stack (string) from loop_control.
#
# Atomic deploy: writes .env and compose to temp files, validates against those,
# then moves into place only on success. Originals are preserved on validation failure.
#
# Steps: mkdir -> template .env.new -> copy compose.new -> validate -> move -> up -d -> wait (databases)

- name: "Create stack directory — {{ _current_stack }}"
  become: true
  ansible.builtin.file:
    path: "{{ stacks_base_path }}/{{ _current_stack }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- block:
    - name: "Template .env (staging) — {{ _current_stack }}"
      become: true
      ansible.builtin.template:
        src: "stacks/{{ _current_stack }}/env.j2"
        dest: "{{ stacks_base_path }}/{{ _current_stack }}/.env.new"
        owner: root
        group: root
        mode: "0600"
      no_log: "{{ not (debug_no_log | default(false) | bool) and (ansible_verbosity | default(0) | int < 3) }}"
  rescue:
    - ansible.builtin.fail:
        msg: "Template .env for stack '{{ _current_stack }}' failed (undefined variable?). Re-run with -e debug_no_log=yes for details."

- name: "Copy docker-compose.yaml (staging) — {{ _current_stack }}"
  become: true
  ansible.builtin.copy:
    src: "stacks/{{ _current_stack }}/docker-compose.yaml"
    dest: "{{ stacks_base_path }}/{{ _current_stack }}/docker-compose.yaml.new"
    owner: root
    group: root
    mode: "0644"

- name: "Check for custom-cont-init.d — {{ _current_stack }}"
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/stacks/{{ _current_stack }}/custom-cont-init.d"
  delegate_to: localhost
  become: false
  register: _custom_init_stat
  changed_when: false

- name: "Sync custom-cont-init.d scripts — {{ _current_stack }}"
  become: true
  ansible.builtin.copy:
    src: "stacks/{{ _current_stack }}/custom-cont-init.d/"
    dest: "{{ stacks_base_path }}/{{ _current_stack }}/custom-cont-init.d/"
    owner: root
    group: root
    mode: "0755"
  when: _custom_init_stat.stat.exists | default(false)

- name: "Check for docker-compose.override.j2 — {{ _current_stack }}"
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/stacks/{{ _current_stack }}/docker-compose.override.j2"
  delegate_to: localhost
  become: false
  register: _override_j2_stat
  changed_when: false

- name: "Check for docker-compose.test.j2 — {{ _current_stack }}"
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/stacks/{{ _current_stack }}/docker-compose.test.j2"
  delegate_to: localhost
  become: false
  register: _test_override_j2_stat
  changed_when: false
  when: _test_mode | default(false) | bool

- name: "Template docker-compose.override.yaml (test mode) — {{ _current_stack }}"
  become: true
  ansible.builtin.template:
    src: "stacks/{{ _current_stack }}/docker-compose.test.j2"
    dest: "{{ stacks_base_path }}/{{ _current_stack }}/docker-compose.override.yaml"
    owner: root
    group: root
    mode: "0644"
  when:
    - _test_mode | default(false) | bool
    - _test_override_j2_stat.stat.exists | default(false)

- name: "Template docker-compose.override.yaml — {{ _current_stack }}"
  become: true
  ansible.builtin.template:
    src: "stacks/{{ _current_stack }}/docker-compose.override.j2"
    dest: "{{ stacks_base_path }}/{{ _current_stack }}/docker-compose.override.yaml"
    owner: root
    group: root
    mode: "0644"
  when:
    - _override_j2_stat.stat.exists
    - not (_test_mode | default(false) | bool and _test_override_j2_stat.stat.exists | default(false))

- name: "Patch compose for homelab network — {{ _current_stack }}"
  include_tasks: tasks/patch_compose_networks.yaml
  vars:
    _compose_file: "{{ stacks_base_path }}/{{ _current_stack }}/docker-compose.yaml.new"
    _env_file: "{{ stacks_base_path }}/{{ _current_stack }}/.env.new"
  when: patch_compose_networks | default(false) | bool

- name: "Validate compose config — {{ _current_stack }}"
  become: true
  ansible.builtin.command:
    cmd: docker compose -f docker-compose.yaml.new --env-file .env.new config --quiet
    chdir: "{{ stacks_base_path }}/{{ _current_stack }}"
  changed_when: false
  when: not ansible_check_mode

- name: "Activate validated config — {{ _current_stack }}"
  become: true
  ansible.builtin.shell: |
    mv -f {{ stacks_base_path }}/{{ _current_stack }}/.env.new {{ stacks_base_path }}/{{ _current_stack }}/.env
    mv -f {{ stacks_base_path }}/{{ _current_stack }}/docker-compose.yaml.new {{ stacks_base_path }}/{{ _current_stack }}/docker-compose.yaml
  when: not ansible_check_mode

- name: "Pull images — {{ _current_stack }}"
  become: true
  ansible.builtin.command:
    cmd: docker compose pull
    chdir: "{{ stacks_base_path }}/{{ _current_stack }}"
  register: _pull_result
  changed_when: "'Pull complete' in (_pull_result.stderr | default('')) or 'Downloaded' in (_pull_result.stderr | default(''))"
  retries: 3
  delay: 15
  until: _pull_result is not failed
  when:
    - not ansible_check_mode
    - pull_only | default('') == 'yes'

- name: "Start stack — {{ _current_stack }}"
  become: true
  community.docker.docker_compose_v2:
    project_src: "{{ stacks_base_path }}/{{ _current_stack }}"
    state: present
    remove_orphans: true
  register: _compose_up_result
  retries: 3
  delay: 15
  until: _compose_up_result is not failed
  when:
    - not ansible_check_mode
    - not (validate_only | default('') == 'yes')
    - not (pull_only | default('') == 'yes')

- name: "Discover wait ports from labels — {{ _current_stack }}"
  become: true
  ansible.builtin.shell: |
    ids=$(docker ps -q \
      --filter "label=com.docker.compose.project={{ _current_stack }}" \
      --filter "label=homelab.wait_port")
    [ -z "$ids" ] && exit 0
    echo "$ids" | xargs docker inspect \
      --format '{% raw %}{{index .Config.Labels "homelab.wait_port"}}{% endraw %}'
  register: _label_wait_ports
  changed_when: false
  when: not ansible_check_mode

- name: "Wait for stack ports — {{ _current_stack }}"
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ item | int }}"
    timeout: 60
  loop: "{{ _label_wait_ports.stdout_lines | default([]) | reject('eq', '') | list }}"
  when:
    - not ansible_check_mode
    - not (validate_only | default('') == 'yes')
    - not (pull_only | default('') == 'yes')
    - _label_wait_ports.stdout_lines | default([]) | reject('eq', '') | list | length > 0
