---
# Reset database root passwords to match vault variables.
# After restoring appdata from backup, the MariaDB/Postgres data files may
# contain a different root password than the vault. MYSQL_ROOT_PASSWORD and
# POSTGRES_PASSWORD env vars are only applied on first-time initialization —
# if data already exists, the container ignores them.
#
# This task uses socket/trust auth (available via docker exec) to force-reset
# the root password so subsequent restore commands can authenticate.
#
# Expects:
#   _db_mariadb_password — desired MariaDB root password
#   _db_postgres_password — desired Postgres superuser password
# Optional:
#   _db_mariadb_container — MariaDB container name (default: 'mariadb')
#   _db_postgres_container — Postgres container name (default: 'postgres')

- name: Detect running database containers
  ansible.builtin.shell: |
    mariadb=false; postgres=false
    docker ps -q --filter "name=^${MARIA_CONTAINER}$" | grep -q . && mariadb=true
    docker ps -q --filter "name=^${PG_CONTAINER}$" | grep -q . && postgres=true
    echo "mariadb=$mariadb postgres=$postgres"
  environment:
    MARIA_CONTAINER: "{{ _db_mariadb_container | default('mariadb') }}"
    PG_CONTAINER: "{{ _db_postgres_container | default('postgres') }}"
  become: true
  changed_when: false
  register: _db_container_check

- name: Set container running flags
  ansible.builtin.set_fact:
    _mariadb_running: "{{ 'mariadb=true' in _db_container_check.stdout }}"
    _postgres_running: "{{ 'postgres=true' in _db_container_check.stdout }}"

- name: Wait for MariaDB to stabilize and reset root password
  ansible.builtin.shell: |
    # LinuxServer MariaDB starts briefly for init, stops, then restarts.
    # A single mysqladmin ping can catch the first (ephemeral) startup.
    # Loop until GRANT succeeds — covers both socket readiness and auth reset.
    for i in $(seq 1 120); do
      if docker exec "$MARIA_CONTAINER" mariadb -u root --skip-password -e "
        GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost'
          IDENTIFIED BY '$DB_PASSWORD' WITH GRANT OPTION;
        FLUSH PRIVILEGES;" 2>/dev/null; then
        # root@'%' may not exist — ignore errors
        docker exec "$MARIA_CONTAINER" mariadb -u root --skip-password -e "
          GRANT ALL PRIVILEGES ON *.* TO 'root'@'%'
            IDENTIFIED BY '$DB_PASSWORD' WITH GRANT OPTION;
          FLUSH PRIVILEGES;" 2>/dev/null || true
        echo "password reset successful on attempt $i"
        exit 0
      fi
      sleep 2
    done
    echo "timeout — MariaDB never became ready for password reset"
    exit 1
  environment:
    DB_PASSWORD: "{{ _db_mariadb_password }}"
    MARIA_CONTAINER: "{{ _db_mariadb_container | default('mariadb') }}"
  become: true
  no_log: "{{ not (debug_no_log | default(false) | bool) and (ansible_verbosity | default(0) | int < 3) }}"
  when: _mariadb_running | bool
  changed_when: true

- name: Wait for Postgres to accept connections
  ansible.builtin.shell: |
    for i in $(seq 1 30); do
      docker exec "$PG_CONTAINER" pg_isready -U "$PG_USER" >/dev/null 2>&1 && exit 0
      sleep 2
    done
    echo "timeout waiting for $PG_CONTAINER"
    exit 1
  environment:
    PG_CONTAINER: "{{ _db_postgres_container | default('postgres') }}"
    PG_USER: "{{ _db_postgres_username | default('postgres') }}"
  become: true
  changed_when: false
  when: _postgres_running | bool

- name: Reset Postgres superuser password to match vault
  ansible.builtin.shell: |
    docker exec "$PG_CONTAINER" psql -U "$PG_USER" -c "ALTER USER $PG_USER WITH PASSWORD '$DB_PASSWORD';"
  environment:
    DB_PASSWORD: "{{ _db_postgres_password }}"
    PG_CONTAINER: "{{ _db_postgres_container | default('postgres') }}"
    PG_USER: "{{ _db_postgres_username | default('postgres') }}"
  become: true
  no_log: "{{ not (debug_no_log | default(false) | bool) and (ansible_verbosity | default(0) | int < 3) }}"
  when: _postgres_running | bool
  changed_when: true

- name: Verify MariaDB root auth after password reset
  ansible.builtin.shell: |
    for i in $(seq 1 10); do
      docker exec -e MYSQL_PWD="$DB_PASSWORD" "$MARIA_CONTAINER" mariadb -u root -e "SELECT 1" 2>/dev/null && exit 0
      sleep 2
    done
    docker exec -e MYSQL_PWD="$DB_PASSWORD" "$MARIA_CONTAINER" mariadb -u root -e "SELECT 1"
  environment:
    DB_PASSWORD: "{{ _db_mariadb_password }}"
    MARIA_CONTAINER: "{{ _db_mariadb_container | default('mariadb') }}"
  become: true
  changed_when: false
  no_log: "{{ not (debug_no_log | default(false) | bool) and (ansible_verbosity | default(0) | int < 3) }}"
  when: _mariadb_running | bool
