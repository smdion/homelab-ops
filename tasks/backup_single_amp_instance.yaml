---
# Back up a single AMP game server instance.
# Called in a loop from backup_hosts.yaml with loop_var: _amp_instance.
#
# Stops the instance, archives its data dir (excluding re-downloadable Versions/),
# restarts the instance, then fetches to controller (instance is back online during
# transfer). On failure the instance is restarted and the failure recorded
# (not re-raised — caller checks _amp_backup_results).
# Instances that were offline before backup are not started afterward.
#
# Required (from caller scope):
#   _amp_instance         — instance name (e.g. 'ADS01', 'Minecraft01')
#   amp_home              — AMP user home dir (e.g. /home/amp)
#   amp_user              — AMP unix user (e.g. amp)
#   backup_tmp_dir        — temp directory for archive creation
#   ansible_date_time     — gathered fact
#   _amp_backup_results   — list to append results to (caller initializes to [])
#   backup_base_dir       — controller-side backup root (for fetch dest)

- name: Set archive filename for {{ _amp_instance }}
  ansible.builtin.set_fact:
    _amp_archive_name: "backup_amp_{{ _amp_instance }}_{{ ansible_date_time.date }}.tar.gz"

- name: Check if AMP instance {{ _amp_instance }} is running before backup
  become: true
  become_user: "{{ amp_user }}"
  become_method: su
  become_exe: sudo su -l
  ansible.builtin.shell: |
    ampinstmgr list 2>/dev/null \
      | awk '/{{ _amp_instance }}/{found=1} found && /Running/{print; exit}' \
      | grep -q "Yes"
  args:
    executable: /bin/bash
  register: _amp_was_running_check
  changed_when: false
  failed_when: false

- name: Record pre-backup running state for {{ _amp_instance }}
  ansible.builtin.set_fact:
    _amp_was_running: "{{ _amp_was_running_check.rc == 0 }}"

- block:
    - name: Stop AMP instance {{ _amp_instance }}
      become: true
      become_user: "{{ amp_user }}"
      become_method: su
      become_exe: sudo su -l
      ansible.builtin.shell: ampinstmgr StopInstance {{ _amp_instance }}
      args:
        executable: /bin/bash
      changed_when: true

    - name: Wait for AMP instance {{ _amp_instance }} to fully stop
      become: true
      become_user: "{{ amp_user }}"
      become_method: su
      become_exe: sudo su -l
      ansible.builtin.shell: |
        ampinstmgr list 2>/dev/null \
          | awk '/{{ _amp_instance }}/{found=1} found && /Running/{print; exit}' \
          | grep -q "No"
      args:
        executable: /bin/bash
      register: _amp_stop_status
      until: _amp_stop_status.rc == 0
      retries: 30
      delay: 5
      changed_when: false

    - name: Create compressed archive for {{ _amp_instance }}
      become: true
      ansible.builtin.shell: |
        {{ _gz_detect }}
        tar --ignore-failed-read \
            --exclude="{{ amp_home }}/.ampdata/instances/{{ _amp_instance }}/Versions" \
            --exclude="{{ amp_home }}/.ampdata/instances/{{ _amp_instance }}/Backups" \
            -I "$_gz -1" -cf "{{ backup_tmp_dir }}/{{ _amp_archive_name }}" \
            -C "{{ amp_home }}/.ampdata/instances" \
            "{{ _amp_instance }}"
      args:
        executable: /bin/bash
      register: _amp_tar
      changed_when: true
      failed_when: _amp_tar.rc > 1  # rc=1 = files changed/removed during shutdown (expected); rc=2 = fatal
      timeout: "{{ amp_backup_timeout | default(1800) }}"

    - name: Get archive file size for {{ _amp_instance }}
      ansible.builtin.stat:
        path: "{{ backup_tmp_dir }}/{{ _amp_archive_name }}"
      register: _amp_file_size
      changed_when: false

    - name: Start AMP instance {{ _amp_instance }} (reduce downtime during fetch)
      become: true
      become_user: "{{ amp_user }}"
      become_method: su
      become_exe: sudo su -l
      ansible.builtin.shell: ampinstmgr StartInstance {{ _amp_instance }}
      args:
        executable: /bin/bash
      changed_when: true
      ignore_errors: true
      when: _amp_was_running | default(false)

    - name: Delete stale archive on controller for {{ _amp_instance }}
      ansible.builtin.file:
        path: "{{ backup_base_dir }}/{{ inventory_hostname }}/{{ _amp_archive_name }}"
        state: absent
      delegate_to: localhost
      become: false

    - name: Fetch {{ _amp_instance }} archive to controller
      ansible.builtin.fetch:
        src: "{{ backup_tmp_dir }}/{{ _amp_archive_name }}"
        dest: "{{ backup_base_dir }}/{{ inventory_hostname }}/{{ _amp_archive_name }}"
        flat: true
      become: false

    - name: Record success for {{ _amp_instance }}
      ansible.builtin.set_fact:
        _amp_backup_results: >-
          {{ _amp_backup_results + [{'instance': _amp_instance,
             'file': _amp_archive_name,
             'file_size': _amp_file_size.stat.size | default(0),
             'failed': false}] }}

  rescue:
    - name: Record failure for {{ _amp_instance }}
      ansible.builtin.set_fact:
        _amp_backup_results: >-
          {{ _amp_backup_results + [{'instance': _amp_instance,
             'file': _amp_archive_name,
             'file_size': 0,
             'failed': true}] }}

  always:
    - name: Start AMP instance {{ _amp_instance }}
      become: true
      become_user: "{{ amp_user }}"
      become_method: su
      become_exe: sudo su -l
      ansible.builtin.shell: ampinstmgr StartInstance {{ _amp_instance }}
      args:
        executable: /bin/bash
      changed_when: true
      ignore_errors: true
      when: _amp_was_running | default(false)

    - name: Wait for AMP instance {{ _amp_instance }} to be running
      become: true
      become_user: "{{ amp_user }}"
      become_method: su
      become_exe: sudo su -l
      ansible.builtin.shell: |
        ampinstmgr list 2>/dev/null \
          | awk '/{{ _amp_instance }}/{found=1} found && /Running/{print; exit}' \
          | grep -q "Yes"
      args:
        executable: /bin/bash
      register: _amp_start_status
      until: _amp_start_status.rc == 0
      retries: 30
      delay: 5
      changed_when: false
      ignore_errors: true
      when: _amp_was_running | default(false)

    - name: Delete temp archive for {{ _amp_instance }}
      become: true
      ansible.builtin.file:
        path: "{{ backup_tmp_dir }}/{{ _amp_archive_name }}"
        state: absent
