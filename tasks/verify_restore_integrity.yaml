---
# Verify restored appdata integrity after archive extraction, before container start.
# Lists archive contents vs actual filesystem to catch missing/overwritten files.
#
# Expects:
#   _archive_files — list of archive paths (from hostvars['localhost'])
#   backup_tmp_dir — temp directory on target host
# Sets:
#   _restore_integrity_summary — human-readable verification result

- name: Verify restored files match archive contents
  become: true
  ansible.builtin.shell: |
    set -e
    errors=0
    checked=0
    missing=""

    {% for archive in hostvars['localhost']._archive_files %}
    echo "=== Checking archive: {{ archive | basename }} ==="

    # List files in archive (sample up to 50 files, skip directories)
    archive_files=$(tar -tzf "{{ backup_tmp_dir }}/restore_inplace.tar.gz" 2>/dev/null \
      | grep -v '/$' | head -50) || true

    # rsync the archive to tmp for listing (it may have been cleaned up)
    # Fall back to listing what's on disk from the archive's top-level dirs
    archive_dirs=$(tar -tzf "{{ backup_tmp_dir }}/restore_inplace.tar.gz" 2>/dev/null \
      | head -20 | cut -d'/' -f1-2 | sort -u) || true

    for f in $archive_files; do
      if [ -e "/$f" ]; then
        checked=$((checked + 1))
      else
        errors=$((errors + 1))
        missing="$missing\n  /$f"
      fi
    done
    {% endfor %}

    echo ""
    echo "Files checked: $checked"
    echo "Files missing: $errors"
    if [ -n "$missing" ]; then
      echo -e "Missing files:$missing"
    fi

    # Also check ownership of key directories
    echo ""
    echo "=== /opt directory ownership ==="
    ls -la /opt/ | grep -v "^total"

    if [ "$errors" -gt 0 ]; then
      echo ""
      echo "RESULT: $errors file(s) missing after restore"
      exit 1
    fi
    echo ""
    echo "RESULT: All $checked sampled files present after restore"
  register: _integrity_check
  changed_when: false
  failed_when: false

- name: Display restore integrity results
  ansible.builtin.debug:
    msg: "{{ _integrity_check.stdout }}"

- name: Set integrity summary
  ansible.builtin.set_fact:
    _restore_integrity_summary: "{{ _integrity_check.stdout_lines | last | default('unknown') }}"
