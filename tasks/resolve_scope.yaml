---
# Shared scope resolution for docker_stacks playbooks.
# Injects role into host_roles for hosts not already mapped (test VMs),
# then filters hosts by stack/role scope selectors via meta: end_host.
#
# When role is injected (host not in host_roles), sets _role_injected=true.
# Templates use this to derive VIPs from the VM's actual subnet instead of
# vault VIPs (test VMs are on an isolated VLAN).
#
# Include in pre_tasks after assert_config_file and after any
# backward-compatible alias resolution (e.g. deploy_stack → stack).
#
# Expects (from caller scope, all optional):
#   role          — target all stacks in a role; also injects into host_roles
#                   for hosts not already mapped
#   stack         — target a single stack (canonical scope selector)
#   app           — target a single app (resolves to stack via app_definitions)

# --- resolve app → stack alias ---
- name: Resolve app → stack alias
  ansible.builtin.set_fact:
    stack: "{{ app_definitions[app].stack }}"
  when:
    - app is defined
    - stack is not defined
    - app in (app_definitions | default({}))

- name: Assert app exists in app_definitions
  ansible.builtin.assert:
    that: app in (app_definitions | default({}))
    fail_msg: >-
      '{{ app }}' not found in app_definitions.
      Valid apps: {{ (app_definitions | default({})).keys() | list | join(', ') }}
  when:
    - app is defined
    - stack is not defined

# --- inject role for unmapped hosts (test VMs) ---
- name: Inject role into host_roles (host not already mapped)
  ansible.builtin.set_fact:
    host_roles: "{{ host_roles | combine({inventory_hostname: role}) }}"
    _role_injected: true
  when:
    - role is defined
    - inventory_hostname not in host_roles | default({})

- name: Clear _role_injected for mapped hosts
  ansible.builtin.set_fact:
    _role_injected: false
  when: _role_injected is not defined

# --- scope filters ---
- name: Skip host — stack not assigned here
  meta: end_host
  when:
    - stack is defined
    - inventory_hostname in groups["docker_stacks"] | default([])
    - stack not in (stack_assignments[inventory_hostname] | default([]))

- name: Skip host — role does not match
  meta: end_host
  when:
    - role is defined
    - inventory_hostname in groups["docker_stacks"] | default([])
    - host_roles[inventory_hostname] | default('') != role
