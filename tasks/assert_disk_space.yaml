---
# Pre-task assertion: verify sufficient disk space before operations.
# Pass all variables via vars: on the include_tasks call.
#
# Required vars:
#   assert_disk_path   — filesystem path to check (e.g., /backup, /tmp/backup)
#   assert_disk_min_gb — minimum free space in GB (e.g., 2)
#
# Optional vars:
#   assert_disk_delegate_to — delegate to a different host (e.g., localhost)
#   assert_disk_become      — override become (e.g., false)

- name: Check available disk space on {{ assert_disk_path }}
  ansible.builtin.shell: p="{{ assert_disk_path }}"; while [ ! -d "$p" ]; do p=$(dirname "$p"); done; df -k "$p" | tail -1 | awk '{print $4}'
  register: _disk_avail_kb
  changed_when: false
  check_mode: false
  delegate_to: "{{ assert_disk_delegate_to | default(omit) }}"
  become: "{{ assert_disk_become | default(omit) }}"

- name: Assert sufficient disk space on {{ assert_disk_path }}
  ansible.builtin.assert:
    that: _disk_avail_kb.stdout | int > (assert_disk_min_gb | int * 1048576)
    fail_msg: >-
      Less than {{ assert_disk_min_gb }} GB free on {{ assert_disk_path }}
      ({{ (_disk_avail_kb.stdout | int / 1048576) | round(2) }} GB available) — aborting
  delegate_to: "{{ assert_disk_delegate_to | default(omit) }}"
  become: "{{ assert_disk_become | default(omit) }}"
