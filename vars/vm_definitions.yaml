# VM provisioning definitions for build_ubuntu.yaml
# Each entry maps vm_name → VM spec for Proxmox API.
# Stack assignments derived from stack_assignments in vars/docker_stacks.yaml (single source of truth).

# Proxmox infrastructure defaults — shared across all VMs.
# pve_api_host, pve_api_user, pve_api_token_id, pve_api_token_secret, vm_password
# are secrets — defined in vars/secrets.yaml.
#
# Network topology and node names are deployment-specific and must be set in vault:
#   vault_vm_gateway        — default gateway IP for all VMs
#   vault_vm_dns            — DNS server IP for all VMs
#   vault_vm_search_domain  — DNS search domain (e.g. "homelab.local")
#   vault_pve_template_node — PVE node where the cloud-init template config file lives
pve_storage: "replicated"
pve_bridge: "vmbr0"
vm_user: "ansible"
vm_gateway: "{{ vault_vm_gateway }}"
vm_dns: "{{ vault_vm_dns }}"
vm_search_domain: "{{ vault_vm_search_domain }}"
vm_cidr: 24

# Cloud-init template — created automatically on first build.
# Ceph (replicated) storage is shared across all nodes, so one template serves the entire cluster.
# pve_template_node must match the node pve_api_host resolves to — that's where the
# template config file lives. Clones use Ceph shared storage to target any node.
pve_template_vmid: 9000
pve_template_node: "{{ vault_pve_template_node }}"
pve_template_name: "ubuntu-cloud-template"
pve_cloud_image_url: "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"
vm_template_memory: 2048
vm_template_cores: 2

# vm_definitions: keyed by short name (used as vm_name arg and in stack_assignments).
# Per-VM sensitive values (hostname, IP, PVE target node) come from vault:
#   vault_vm_<name>_hostname  — FQDN for cloud-init hostname and Ansible inventory
#   vault_vm_<name>_ip        — static IP for cloud-init network config
#   vault_vm_<name>_node      — PVE node to place this VM on
#
# test-vm uses a dedicated IP range to avoid updating secrets per build.
# Pass vm_index=0..9 (default 0) to select a slot:
#   vault_test_vm_ip_prefix   — first 3 octets with trailing dot (e.g. "10.10.10.")
#   vault_test_vm_ip_offset   — last octet of the first slot (e.g. 90)
# Resulting IPs: <prefix><offset+vm_index>  (e.g. 10.10.10.90 .. REDACTED_IP)
# VMIDs: 199+vm_index (199..208). VM names: test-vm0..test-vm9.
vm_definitions:
  tantiveiv:
    vm_id: 100
    vm_name: tantive-iv
    vm_hostname: "{{ vault_vm_tantiveiv_hostname }}"
    vm_ip: "{{ vault_vm_tantiveiv_ip }}"
    vm_cores: 4
    vm_memory_mb: 12288
    vm_disk_gb: 200
    pve_target_node: "{{ vault_vm_tantiveiv_node }}"

  odyssey:
    vm_id: 101
    vm_name: odyssey
    vm_hostname: "{{ vault_vm_odyssey_hostname }}"
    vm_ip: "{{ vault_vm_odyssey_ip }}"
    vm_cores: 2
    vm_memory_mb: 4096
    vm_disk_gb: 100
    pve_target_node: "{{ vault_vm_odyssey_node }}"

  amp:
    vm_id: 102
    vm_name: amp
    vm_hostname: "{{ vault_vm_amp_hostname }}"
    vm_ip: "{{ vault_vm_amp_ip }}"
    vm_cores: 4
    vm_memory_mb: 8192
    vm_disk_gb: 100
    pve_target_node: "{{ vault_vm_amp_node }}"

  test-vm:
    vm_id: "{{ (199 + (vm_index | default(0) | int)) | int }}"
    vm_name: "test-vm{{ vm_index | default(0) | int }}"
    vm_hostname: "test-vm{{ vm_index | default(0) | int }}.{{ vault_vm_search_domain }}"
    vm_ip: "{{ vault_test_vm_ip_prefix }}{{ vault_test_vm_ip_offset | int + (vm_index | default(0) | int) }}"
    vm_cores: 2
    vm_memory_mb: 2048
    vm_disk_gb: 20
    pve_target_node: "{{ vault_vm_testvm_node }}"

# Optional per-VM fields (used by tasks/bootstrap_vm.yaml when defined):
#
#   nfs_mounts:                          # List of NFS mounts for /etc/fstab
#     - src: "10.10.10.10:/mnt/share"
#       path: "/mnt/nfs/share"
#       opts: "defaults,_netdev"         # optional, defaults to 'defaults,_netdev'
#
#   ufw_rules:                           # Additional UFW rules beyond SSH (always allowed)
#     - port: "8080"
#       proto: "tcp"                     # optional, defaults to 'tcp'
#       rule: "allow"                    # optional, defaults to 'allow'
#       src: "10.10.10.0/24"            # optional, restrict to source CIDR
#       comment: "Web UI"               # optional
